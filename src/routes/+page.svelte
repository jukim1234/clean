<script>
	/**
	 [ ë½€ë“ AI ì „ë¬¸ ì§„ë‹¨ ì‹œìŠ¤í…œ: ì‚¬ì¥ë‹˜ì˜ ì„¤ê³„ ì² í•™ ]
	 * 1. "ë©”ë‰´íŒë§Œ ë³´ê³  ë‚˜ê°€ëŠ” ê±´ ì‹«ì–´ìš”" (ë³´ì•ˆê³¼ ëª°ì…)
	 - ì²˜ìŒì—” í¼ì§í•˜ê²Œ 4ê°œ ì¹´í…Œê³ ë¦¬ë§Œ ë³´ì—¬ì¤˜ì„œ ë½€ë“ì´ ë­˜ ì˜í•˜ëŠ”ì§€ ë”± ë³´ì—¬ì¤ë‹ˆë‹¤.
	 - í•˜ì§€ë§Œ ê·¸ ë‹¤ìŒë¶€í„´ ë²„íŠ¼ í´ë¦­ì´ ì•„ë‹ˆë¼, ê³ ê°ì´ ì§ì ‘ ìê¸° ì‚¬ì—°ì„ ì ê²Œ ë§Œë“¤ì—ˆì–´ìš”.
	 - ì´ë ‡ê²Œ í•˜ë©´ ê²½ìŸì‚¬ë“¤ì´ ìš°ë¦¬ ë¡œì§ì„ í›”ì³ë³´ê¸°ë„ ì–´ë µê³ , ê³ ê°ì€ ì§„ì§œ ìƒë‹´ë°›ëŠ” ê¸°ë¶„ì´ ë“­ë‹ˆë‹¤.
	 * 2. "ê³ ê°ì´ ë¬´ìŠ¨ ë§ì„ í• ì§€ ë¯¸ë¦¬ ì•Œê³  ëŒ€ë‹µí•˜ê¸°" (ë§¥ë½ íŒŒì•…)
	 - ê³ ê°ì´ 'ì°½í‹€'ì´ë¼ê³ ë§Œ ì¨ë„, ìš°ë¦¬ AIëŠ” "ì•„, ê³°íŒ¡ì´ ë•Œë¬¸ì— ê³ ë¯¼ì´ì‹œêµ¬ë‚˜" í•˜ê³  ëˆˆì¹˜ë¥¼ ì±•ë‹ˆë‹¤.
	 - ê·¸ë˜ì„œ ë‹¤ìŒ ì§ˆë¬¸ì°½ì— "ì°½í‹€ ê³°íŒ¡ì´ ìƒíƒœëŠ” ì–´ë–¤ê°€ìš”?" ê°™ì€ ë§ì¶¤í˜• ê°€ì´ë“œ(Placeholder)ë¥¼ ë„ì›Œì£¼ì£ .
	 * 3. "ë²ˆí˜¸ ëˆ„ë¥´ëŠ” ê±´ ê¸°ê³„ ê°™ì–ì•„ìš”" (ëŒ€í™”í˜• ì¸í„°í˜ì´ìŠ¤)
	 - 1ë²ˆ, 2ë²ˆ ë²„íŠ¼ ëˆ„ë¥´ëŠ” ëŒ€ì‹  "ì´ì‚¬ ê°€ì‹œëŠ” ê±´ì§€, ì‚´ë©´ì„œ ì²­ì†Œí•˜ì‹œëŠ” ê±´ì§€" ì§ì ‘ ë‹¨ì–´ë¡œ ì…ë ¥ë°›ê²Œ í–ˆìŠµë‹ˆë‹¤.
	 - ì˜ˆì‹œì— ì—†ëŠ” íŠ¹ì´í•œ ìƒí™©(ì˜ˆ: ë²½ì§€ ë‹ˆì½”í‹´)ì„ ì…ë ¥í•´ë„ AIê°€ ë‹¤ ì•Œì•„ë“£ê³  ëŒ€ì‘í•©ë‹ˆë‹¤.
	 * 4. "í•œëˆˆì— ë“¤ì–´ì˜¤ëŠ” ê¹”ë”í•œ ì²«ì¸ìƒ" (2x2 ê·¸ë¦¬ë“œ)
	 - ì²« í™”ë©´ì€ ìŠ¤ë§ˆíŠ¸í°ì—ì„œ ë³´ê¸° í¸í•˜ê²Œ 2ê°œì”© ì§ì§€ì–´ì„œ 2í–‰ìœ¼ë¡œ ë”± ë§ì·„ìŠµë‹ˆë‹¤.
	 - ë½€ë“ì˜ 4ëŒ€ í•µì‹¬ ì„œë¹„ìŠ¤(ê³µê°„ìœ í˜•, ì˜¤ì—¼ì²˜ë¦¬, ë¶„ë¦¬ìˆ˜ê±°, ë§ˆì¸ë“œì…‹)ê°€ í•œëˆˆì— ë“¤ì–´ì˜µë‹ˆë‹¤.
	 * 5. "ê²°êµ­ ì¤‘ìš”í•œ ê±´ ì „ë¬¸ê°€ì˜ ì²˜ë°©ì „" (ë¦¬í¬íŠ¸ ë°œí–‰)
	 - ëŒ€í™”ê°€ ëë‚˜ë©´ ì‚¬ì¥ë‹˜ì˜ 15ë…„ ë…¸í•˜ìš°ê°€ ë‹´ê¸´ 'ì§„ë‹¨ì„œ'ê°€ ë‚˜ì˜µë‹ˆë‹¤.
	 - ì‚¬ì§„ê¹Œì§€ ë¶„ì„í•´ì„œ ì‘ì—…ìê°€ í˜„ì¥ì—ì„œ ê¼­ ë´ì•¼ í•  ì²´í¬ë¦¬ìŠ¤íŠ¸ê¹Œì§€ ë½‘ì•„ì£¼ëŠ” ì•„ì£¼ ë˜‘ë˜‘í•œ ë…€ì„ì…ë‹ˆë‹¤.
	 */

	import { onMount } from 'svelte';

	let GoogleGenerativeAI;
	let genAI;

	let step = 1; 
	let mainSelection = '';
	let subTopic = ''; 
	let placeholderText = 'ìƒì„¸í•œ ìƒí™©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.';
	let chatLog = [];

	let userQuestion = '';
	let resultHtml = '';
	let isLoading = false;
	let imageInput;

	const mainOptions = [
		{ id: 'space', label: 'ğŸ  ì²­ì†Œ ê³µê°„ ìœ í˜•', desc: 'ì´ì‚¬/ê±°ì£¼/ë¶€ë¶„' },
		{ id: 'stain', label: 'ğŸ“ ì„¸ë¶€ ì˜¤ì—¼ ì²˜ë¦¬', desc: 'ì°½í‹€, ì£¼ë°©, ìš•ì‹¤ ë“±' },
		{ id: 'recycle', label: 'â™»ï¸ ë¶„ë¦¬ìˆ˜ê±°/ë°°ì¶œ', desc: 'ë°°ì¶œ ì›ì¹™, ë°©ë²•' },
		{ id: 'mind', label: 'ğŸ§¹ ì‹œì‘ ë§ˆì¸ë“œì…‹', desc: 'ë™ê¸°ë¶€ì—¬, ë£¨í‹´' }
	];

	const getDynamicGuide = (topic) => {
		const t = topic.toLowerCase();
		if (t.includes('ì°½í‹€') || t.includes('ë² ë€ë‹¤')) return "ì˜ˆ: ì°½í‹€ í•˜ë‹¨ ê³°íŒ¡ì´ê°€ ì‹¬í•˜ê³  ì™¸ì°½ì— ì°Œë“  ë¨¼ì§€ê°€ ë§ìŠµë‹ˆë‹¤. ì œê±° ê°€ëŠ¥í•œê°€ìš”?";
		if (t.includes('ì£¼ë°©') || t.includes('ìš•ì‹¤') || t.includes('í›„ë“œ')) return "ì˜ˆ: ì£¼ë°© í›„ë“œ ê¸°ë¦„ë•Œê°€ ë”±ë”±í•˜ê³ , ìš•ì‹¤ íƒ€ì¼ ì‚¬ì´ ë³€ìƒ‰ì´ ì‹¬í•©ë‹ˆë‹¤.";
		if (t.includes('ì´ì‚¬') || t.includes('ì…ì£¼')) return "ì˜ˆ: 24í‰í˜• ì‹ ì¶• ì•„íŒŒíŠ¸ ì…ì£¼ ì˜ˆì •ì…ë‹ˆë‹¤. ê³µì‚¬ ë¶„ì§„ ê°€ë£¨ê°€ ì§‘ì•ˆ ì „ì²´ì— ê°€ë“í•©ë‹ˆë‹¤.";
		if (t.includes('ê±°ì£¼') || t.includes('ë¶€ë¶„') || t.includes('ì „ì²´')) return "ì˜ˆ: ê±°ì£¼ ì¤‘ì¸ ì§‘ì˜ ê±°ì‹¤ ë°”ë‹¥ì— ë°˜ë ¤ë™ë¬¼ ì–¼ë£©ê³¼ ëƒ„ìƒˆê°€ ë°°ì–´ìˆì–´ íŠ¹ìˆ˜ ì„¸ì²™ì´ í•„ìš”í•©ë‹ˆë‹¤.";
		return `ì˜ˆ: '${topic}' ê´€ë ¨í•˜ì—¬ í˜„ì¬ ìƒí™©(ë²”ìœ„, ì˜¤ì—¼ ì •ë„ ë“±)ì„ êµ¬ì²´ì ìœ¼ë¡œ ì•Œë ¤ì£¼ì‹œë©´ ë½€ë“ ì „ë¬¸ê°€ê°€ ì§„ë‹¨í•´ ë“œë¦½ë‹ˆë‹¤.`;
	};

	onMount(async () => {
		try {
			const module = await import('https://esm.run/@google/generative-ai');
			GoogleGenerativeAI = module.GoogleGenerativeAI;
			const API_KEY = import.meta.env.VITE_GEMINI_API_KEY;
			if (API_KEY) genAI = new GoogleGenerativeAI(API_KEY);
		} catch (e) { console.error("API ë¡œë“œ ì‹¤íŒ¨", e); }
	});

	function handleMainSelect(id) {
		mainSelection = id;
		let questionMsg = "";
		
		if (id === 'space') {
			questionMsg = "ì²­ì†Œ ê³µê°„ ìœ í˜•ì— ëŒ€í•´ ì•Œë ¤ì£¼ì„¸ìš”. (ì˜ˆ: ê±°ì£¼ ê³µê°„ ì¼ë¶€/ì „ì²´, ì¼ë°˜ ì´ì‚¬, ì—…ì²´ ì…ì£¼ ë“±)";
		} else if (id === 'stain') {
			questionMsg = "ì§‘ì¤‘ ì§„ë‹¨ì´ í•„ìš”í•œ ì˜¤ì—¼ êµ¬ì—­ì— ëŒ€í•´ ì•Œë ¤ì£¼ì„¸ìš”. (ì˜ˆ: ì°½í‹€ ë° ë² ë€ë‹¤, ì£¼ë°© ë° ìš•ì‹¤, ë°”ë‹¥ ì˜¤ì—¼ ë“±)";
		} else if (id === 'recycle') {
			questionMsg = "ë¬¸ì˜í•˜ì‹¤ ë¶„ë¦¬ìˆ˜ê±° í’ˆëª©ì´ë‚˜ ë°°ì¶œ ìƒí™©ì„ ì•Œë ¤ì£¼ì„¸ìš”. (ì˜ˆ: ê°€ì „ ë°°ì¶œ, í”Œë¼ìŠ¤í‹± ë¶„ë¥˜ ë“±)";
		} else {
			questionMsg = "ì–´ë–¤ ë§ˆì¸ë“œì…‹ì´ë‚˜ ì‹¤ì²œ ìš”ë ¹ì´ ê¶ê¸ˆí•˜ì‹ ê°€ìš”? (ì˜ˆ: ì²­ì†Œ ë™ê¸°ë¶€ì—¬, ë§¤ì¼ 10ë¶„ ë£¨í‹´ ë“±)";
		}

		chatLog = [{ role: 'ai', text: questionMsg }];
		step = 2;
	}

	function handleTopicSubmit() {
		if (!subTopic.trim()) {
			alert("ìƒë‹´ ì£¼ì œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
			return;
		}
		placeholderText = getDynamicGuide(subTopic);
		chatLog = [...chatLog, 
			{ role: 'user', text: subTopic },
			{ role: 'ai', text: `'${subTopic}'(ì´)ë¼ê³  ë§ì”€í•˜ì…¨êµ°ìš”. ì „ë¬¸ê°€ê°€ ë” ì •í™•íˆ ì§„ë‹¨í•  ìˆ˜ ìˆê²Œ ìƒì„¸ ìƒí™©ì„ ì•„ë˜ì— ì ì–´ì£¼ì„¸ìš”.` }
		];
		step = 3;
	}

	async function runAI() {
		if (!genAI) return;
		isLoading = true;
		resultHtml = "ë½€ë“ ì „ë¬¸ê°€ AIê°€ ë¦¬í¬íŠ¸ë¥¼ ì‘ì„± ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...";

		try {
			const model = genAI.getGenerativeModel({ model: 'gemini-flash-latest' });
			const prompt = `[ë½€ë“ ì „ë¬¸ê°€ ëª¨ë“œ]\nì£¼ì œ: ${subTopic}\nìƒí™©: ${userQuestion}\n[ë¯¸ì…˜] 15ë…„ ê²½ë ¥ ë…¸í•˜ìš°ë¥¼ ë‹´ì•„ ì¹œì ˆí•˜ë©´ì„œë„ ì „ë¬¸ì ì¸ ê²°í•¨ ì²´í¬ë¦¬ìŠ¤íŠ¸ì™€ ì²˜ë°©ì „ì„ ì‘ì„±í•  ê²ƒ.`;
			
			let parts = [prompt];
			if (imageInput?.files[0]) {
				const base64 = await new Promise((r) => {
					const reader = new FileReader();
					reader.onloadend = () => r(reader.result.split(',')[1]);
					reader.readAsDataURL(imageInput.files[0]);
				});
				parts.push({ inlineData: { data: base64, mimeType: imageInput.files[0].type } });
			}

			const result = await model.generateContent(parts);
			resultHtml = `<strong>âœ¨ ë½€ë“ ì „ë¬¸ ì§„ë‹¨ ë¦¬í¬íŠ¸ âœ¨</strong><br><br>${result.response.text().replace(/\n/g, '<br>')}`;
		} catch (e) { resultHtml = "ì§„ë‹¨ ë„ì¤‘ ë¬¸ì œê°€ ìƒê²¼ì–´ìš”: " + e.message; }
		finally { isLoading = false; }
	}
</script>

<div class="app">
	<header>
		<div class="brand">BBODDEUK AI</div>
		<h1>ì „ë¬¸ê°€ ìƒë‹´ ì„œë¹„ìŠ¤</h1>
	</header>

	{#if step === 1}
		<div class="main-grid">
			{#each mainOptions as opt}
				<button class="menu-card" on:click={() => handleMainSelect(opt.id)}>
					<span class="icon">{opt.label.split(' ')[0]}</span>
					<strong>{opt.label.split(' ').slice(1).join(' ')}</strong>
					<p>{opt.desc}</p>
				</button>
			{/each}
		</div>
	{:else}
		<div class="chat-flow">
			{#each chatLog as chat}
				<div class="msg {chat.role}">
					<div class="bubble">{chat.text}</div>
				</div>
			{/each}

			{#if step === 2}
				<div class="input-row fade-in">
					<input type="text" bind:value={subTopic} placeholder="ì—¬ê¸°ì— ë‚´ìš©ì„ ì¨ì£¼ì„¸ìš”..." on:keypress={(e)=>e.key==='Enter' && handleTopicSubmit()}/>
					<button on:click={handleTopicSubmit}>ì „ì†¡</button>
				</div>
			{/if}

			{#if step === 3}
				<div class="final-form fade-in">
					<div class="field">
						<label>ğŸ“¸ í˜„ì¥ ì‚¬ì§„ì„ ë³´ì—¬ì£¼ì‹œë©´ ë” ì¢‹ì•„ìš”</label>
						<input type="file" bind:this={imageInput} accept="image/*" />
					</div>
					<div class="field">
						<textarea bind:value={userQuestion} placeholder={placeholderText}></textarea>
					</div>
					<div class="action-btns">
						<button class="btn-reset" on:click={()=>{step=1; subTopic=''; userQuestion=''; resultHtml='';}}>ì²˜ìŒìœ¼ë¡œ</button>
						<button class="btn-run" on:click={runAI} disabled={isLoading}>
							{isLoading ? 'ë½€ë“ ì „ë¬¸ê°€ ë¶„ì„ ì¤‘...' : 'ì „ë¬¸ ì§„ë‹¨ì„œ ë°›ê¸°'}
						</button>
					</div>
				</div>
			{/if}
		</div>
	{/if}

	{#if resultHtml}
		<div class="result-viewer fade-in">{@html resultHtml}</div>
	{/if}
</div>

<style>
	:global(body) { background: #f4f6f9; font-family: 'Pretendard', sans-serif; padding: 20px; margin: 0; }
	.app { max-width: 480px; margin: 0 auto; background: #fff; border-radius: 32px; padding: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.05); }
	.brand { color: #1a73e8; font-weight: 800; font-size: 11px; letter-spacing: 1px; text-align: center; margin-bottom: 5px; }
	h1 { font-size: 20px; text-align: center; margin: 0 0 30px 0; color: #222; }

	.main-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
	.menu-card { background: #fff; border: 1.5px solid #eee; border-radius: 20px; padding: 25px 10px; cursor: pointer; transition: 0.2s; border-bottom: 4px solid #eee; }
	.menu-card:hover { border-color: #1a73e8; background: #f8fbff; transform: translateY(-3px); border-bottom-color: #1a73e8; }
	.icon { font-size: 26px; display: block; margin-bottom: 12px; }
	.menu-card strong { display: block; font-size: 14px; color: #333; margin-bottom: 6px; }
	.menu-card p { font-size: 11px; color: #999; margin: 0; line-height: 1.4; }

	.chat-flow { display: flex; flex-direction: column; gap: 16px; }
	.msg { display: flex; flex-direction: column; }
	.msg.ai { align-items: flex-start; }
	.msg.user { align-items: flex-end; }
	.bubble { max-width: 85%; padding: 14px 18px; border-radius: 20px; font-size: 14px; line-height: 1.6; }
	.msg.ai .bubble { background: #f1f3f4; color: #333; border-top-left-radius: 4px; }
	.msg.user .bubble { background: #1a73e8; color: #fff; border-top-right-radius: 4px; }

	.input-row { display: flex; gap: 8px; }
	.input-row input { flex: 1; padding: 14px; border: 1.5px solid #ddd; border-radius: 16px; outline: none; }
	.input-row button { background: #1a73e8; color: white; border: none; padding: 0 20px; border-radius: 16px; font-weight: bold; cursor: pointer; }

	.final-form { background: #f8f9fa; padding: 20px; border-radius: 24px; margin-top: 10px; }
	.field { margin-bottom: 15px; }
	.field label { font-size: 12px; font-weight: bold; color: #666; display: block; margin-bottom: 10px; }
	textarea { width: 100%; height: 130px; border: 1.5px solid #ddd; border-radius: 16px; padding: 15px; box-sizing: border-box; resize: none; font-size: 14px; outline: none; background: #fff; }
	
	.action-btns { display: flex; gap: 10px; margin-top: 15px; }
	.btn-run { flex: 3; background: #1a73e8; color: #fff; border: none; padding: 16px; border-radius: 16px; font-weight: bold; cursor: pointer; }
	.btn-reset { flex: 1; background: #fff; border: 1px solid #ddd; border-radius: 16px; cursor: pointer; font-size: 12px; }

	.result-viewer { margin-top: 30px; background: #fff; border: 2px solid #eef2f6; border-radius: 24px; padding: 25px; font-size: 14px; line-height: 1.8; color: #333; }
	.fade-in { animation: fadeIn 0.4s ease-out; }
	@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>